<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>View section</title>
</head>
<style>
    /*draggable*/
    .draggable {
        position: absolute;
        z-index: 9;
        background-color: #f1f1f1;
        border: 1px solid #d3d3d3;
        text-align: center;
    }

    .draggable-header {
        padding: 10px;
        cursor: move;
        z-index: 10;
        background-color: #2196F3;
        color: #fff;
    }

    .resizer-right {
        width: 5px;
        height: 100%;
        background: transparent;
        position: absolute;
        right: 0;
        bottom: 0;
        cursor: e-resize;
    }

    .resizer-bottom {
        width: 100%;
        height: 5px;
        background: transparent;
        position: absolute;
        right: 0;
        bottom: 0;
        cursor: n-resize;
    }

    .resizer-both {
        width: 5px;
        height: 5px;
        background: transparent;
        z-index: 10;
        position: absolute;
        right: 0;
        bottom: 0;
        cursor: nw-resize;
    }

    /* context menu */
    .context-menu {
        display: none;
        position: absolute;
        z-index: 10;
        padding: 12px 0;
        width: 240px;
        background-color: #fff;
        border: solid 1px #dfdfdf;
        box-shadow: 1px 1px 2px #cfcfcf;
    }

    .context-menu--active {
        display: block;
    }

    .context-menu__items {
        list-style: none;
        margin: 0;
        padding: 0;
    }

    .context-menu__item {
        display: block;
        margin-bottom: 4px;
    }

    .context-menu__item:last-child {
        margin-bottom: 0;
    }

    .context-menu__link {
        display: block;
        padding: 4px 12px;
        color: #0066aa;
        text-decoration: none;
    }

    .context-menu__link:hover {
        color: #fff;
        background-color: #0066aa;
    }
</style>
<body>
<div id="focus-all" tabindex="0">
    <div class="row" id="db_row" style="
            margin-left: 0;
            margin-right: 0;
            ">
        <label for="is_plasma">Is plasma?</label>
        <input type="checkbox" id="is_plasma" checked>
        <label for="shot_select">Shot â„–:</label><select id="shot_select"></select>
        <button class="btn btn-success glyphicon glyphicon-refresh" id="shot_refresh">Refresh</button>
    </div>

    <hr>

    <div class="container-fluid">
        <div class="row">
            <div class="col-xs-8 col-sm-8 col-md-8 col-lg-8">
                <div id="T_evo_chart" style="width:100%; height:400px;" class="context-target" te evo></div>
            </div>
            <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                <div id="T_profile_chart" style="width:100%; height:400px;" class="context-target" te prof></div>
            </div>
        </div>
    </div>
</div>
<div id="singleEventPopup" class="draggable" hidden tabindex="1" style="width: 400px;">
    <div class="container-fluid">
        <div class="row">
            <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
                <div class="draggable-header" tabindex="2">Hold here to move</div>
            </div>
            <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
                <button class="btn btn-danger hide_btn">Hide window</button>
            </div>
        </div>
    </div>

    Your text here.
</div>
<nav id="context-menu" class="context-menu"></nav>
</body>
<script>
    function Main() {
        this.m_defaults = {
            time_min: -2,
            time_max: 5,
            timestamp_title: ' laser energy',
            radius_title: ' spatial points',
            T_evo_title: ' electron temperature evolution',
            T_prof_title: ' electron temperature profile',
            n_evo_title: ' electron density evolution',
            n_prof_title: ' electron density profile',
            w_evo_title: ' electron stored energy evolution',
            nl_evo_title: ' electron density evolution integrated along R=42 chord',
            line_thickness_base: 2,
            line_thickness_high: 4
        };
        this.data_example = [
            {
                x: 0,
                y: 0
            },
            {
                x: 1,
                y: 2
            },
            {
                x: 2,
                y: -1
            }
        ]
        this.palette = [
            '#181818',
            '#FF0000',
            '#0000FF',
            '#00FF00',
            '#8A2BE2',
            '#00FFFF',
            '#006400',
            '#DC143C',
            '#008b8b',
            '#4B0082',
            '#FF8C00',
            '#ADFF2F',
            '#FF00FF',
            '#808000',
            '#FF4500',
            '#FFFF00',
        ];

        this.selectors = {
            singleEventPopup: $('#singleEventPopup')[0],
            draggables: $('.draggable'),
            isShowSingleEvent: $('#is_show'),
            shotn: $('#shot_select'),
            isPlasma: $('#is_plasma'),
        };


        //main charts. see CanvasJS
        this.m_T_evo_chart = new CanvasJS.Chart("T_evo_chart", {
            title: {
                text: 'Electron temperature evolution',
                fontSize: 14,
                fontFamily: 'arial'
            },
            axisY: {
                includeZero: true,
                title: 'Electron temperature, eV',
                titleFontSize: 12,
                //minimum: 0,
                fontFamily: 'arial'
            },
            axisX: {
                title: "Time, ms",
                titleFontSize: 12,
                minimum: this.m_defaults.time_min,
                maximum: this.m_defaults.time_max,
                crosshair: {
                    enabled: true,
                    snapToDataPoint: true,
                    labelFormatter: function (e) {
                        return e.value.toFixed(1);
                    },
                    updated: function (e) {
                        console.log('update crosshair', e);
                    }.bind(this),
                    hidden: function () {
                        console.log('hide crosshair', e);
                    }.bind(this)
                },
                fontFamily: 'arial'
            },
            toolTip: {
                //backgroundColor: "rgba(255,255,255,.2)",
                shared: true,
                contentFormatter: function (e) {
                    let text = '<p>time = ' + e.entries[0].dataPoint.x.toFixed(1) + 'ms</p>';
                    for (let entry of e.entries) {
                        text += '<p style="color:' + entry.dataSeries.color + ';">' + ', T<sub>e</sub> = ' + entry.dataPoint.y.toFixed(1);
                    }
                    return text;
                }.bind(this),
                updated: function (e) {
                    console.log('update toolTip', e);
                }.bind(this),
                hidden: function () {
                    console.log('hide toolTip', e);
                }.bind(this)
            },
            legend: {
                cursor: "pointer",
                itemmouseover: function (e) {
                    if (e.dataSeries.visible) {
                        this.m_T_evo_chart.options.data[e.dataSeriesIndex].lineThickness = this.m_defaults.line_thickness_high;
                        this.m_T_evo_chart.options.data[e.dataSeriesIndex + 1].lineThickness = this.m_defaults.line_thickness_high;
                        this.m_T_evo_chart.render();
                    }
                }.bind(this),
                itemmouseout: function (e) {
                    if (e.dataSeries.visible) {
                        this.m_T_evo_chart.options.data[e.dataSeriesIndex].lineThickness = this.m_defaults.line_thickness_base;
                        this.m_T_evo_chart.options.data[e.dataSeriesIndex + 1].lineThickness = this.m_defaults.line_thickness_base;
                        this.m_T_evo_chart.render();
                    }
                }.bind(this),
                itemclick: function (e) {
                    e.dataSeries.visible = !(typeof (e.dataSeries.visible) === "undefined" || e.dataSeries.visible);
                    this.m_T_evo_chart.options.data[e.dataSeriesIndex + 1].visible = e.dataSeries.visible;
                    this.m_T_evo_chart.render();
                }.bind(this)
            },
            data: []
        });
        this.m_T_evo_chart.render();


        this.Request = function (req, callback) {
            req.subsystem = 'view';
            $.post('/api', JSON.stringify(req), function (resp) {
                if (!resp['ok']) {
                    //console.log(resp);
                    alert(resp['description']);
                } else {
                    callback(resp);
                }
            }, 'json');
        };


        this.UpdateShotSelect = function () {
            let shots = [1, 2, 34];
            if (!this.selectors.isPlasma[0].checked) {
                console.log('isPlasma selected');
            }
            let options = [];
            shots.forEach(shot => options.push("<option>" + shot + "</option>"));
            this.selectors.shotn.html(options);

            if (options.length) {
                this.Select();
            }
        };

        this.DrawMain = function () {
            this.m_T_evo_chart.options.data = [];

            for (let poly_ind = 0; poly_ind < 2; poly_ind++) {
                this.m_T_evo_chart.options.data.push(
                    {
                        type: "line",
                        color: this.palette[poly_ind],
                        visible: true,
                        markerType: "none",
                        showInLegend: true,
                        name: 'R = ' + poly_ind,
                        connectNullData: true,
                        nullDataLineDashType: "dot",
                        dataPoints: [],
                        click: function (event) {
                            this.ShowEvent(event, poly_ind);
                        }.bind(this)
                    }
                );


                for (let event_ind = 0; event_ind < this.data_example.length; event_ind++) {
                    this.m_T_evo_chart.options.data[0].dataPoints.push(
                        {
                            x: this.data_example[event_ind].x,
                            y: this.data_example[event_ind].y
                        }
                    );
                    /*
                same as
                this.m_T_evo_chart.options.data[0].dataPoints.push(this.data_example[event_ind]);
                 */
                }
            }
            this.m_T_evo_chart.render();
        };

        this.Select = function () {
            let shotn = this.selectors.shotn.val();
            let is_plasma = this.selectors.isPlasma[0].checked;
            console.log('Select function called.', shotn, is_plasma);
        };

        this.ShowEvent = function (ev, poly_ind) {
            console.log('showing', ev, poly_ind);
            this.selectors.singleEventPopup.removeAttribute('hidden');
        };


        this.DownloadFile = function (text, filename) {
            /*
            this is how you download a file.
            text is data
             */

            const textToBLOB = new Blob([text], {type: 'text/plain'});

            let newLink = document.createElement("a");
            newLink.download = filename;

            if (window.webkitURL != null) {
                newLink.href = window.webkitURL.createObjectURL(textToBLOB);
            } else {
                newLink.href = window.URL.createObjectURL(textToBLOB);
                newLink.style.display = "none";
                document.body.appendChild(newLink);
            }

            newLink.click();
        };


        this.SavePNG = function () {
            /*
            this is how you save plot as a picture
             */

            this.m_T_evo_chart.exportChart({
                format: 'png',
                fileName: '_Te_evo'
            });
        };


        this.Refresh = function () {
            console.log('Refresh button pressed.');
            this.Request({
                reqtype: 'refresh',
                arg: 'example'
            }, function(resp){
                console.log(resp);
            });
        };


        this.ConnectControls = function () {
            $('#shot_refresh').on('click', this, this.Refresh.bind(this));
            this.selectors.shotn.on('change', this, this.Select.bind(this));
            this.selectors.isPlasma.on('change', this, this.UpdateShotSelect.bind(this));
            $(document).keydown(function (event) {
                console.log('key pressed', event);
            }.bind(this));

            this.initDragElement(this.selectors.draggables);
            this.initResizeElement(this.selectors.draggables);

            $('.hide_btn').each(function (el) {
                this.addEventListener('click', function (e) {
                    $(this).parents('.draggable').attr('hidden', true);
                });
            });

            this.contextMenu();
        };

        this.initDragElement = function (elements) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            let current;
            $(elements).each(function () {
                $(this).find('.draggable-header')[0].onmousedown = dragMouseDown;
                this.style.top = 10 + '%';
                this.style.left = 70 + '%'
            })

            function dragMouseDown(e) {
                current = $(e.target).parents('.draggable')[0];
                //e.preventDefault();
                // get the mouse cursor position at startup:
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                // call a function whenever the cursor moves:
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e.stopPropagation();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;

                current.style.top = (current.offsetTop - pos2) + "px";
                current.style.left = (current.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        };

        //render only child charts
        this.initResizeElement = function (elements) {
            let startX, startY, startWidth, startHeight;
            let current;

            this.doDrag = function (e) {

                e.stopPropagation();
                current.style.width = startWidth + e.clientX - startX + "px";
                current.style.height = startHeight + e.clientY - startY + "px";
            };

            this.stopDrag = function () {
                document.documentElement.removeEventListener("mousemove", this.doDrag, false);
                document.documentElement.removeEventListener("mouseup", this.stopDrag, false);
                //render only child charts

                this.m_fitting_chart.render();
                this.m_raw_chart.render();
                this.m_chi_chart.render();
            }.bind(this);

            this.initDrag = function (e) {
                e.stopPropagation();
                startX = e.clientX;
                startY = e.clientY;
                current = e.target.parentPopup;
                startWidth = parseInt(
                    document.defaultView.getComputedStyle(current).width,
                    10
                );
                startHeight = parseInt(
                    document.defaultView.getComputedStyle(current).height,
                    10
                );
                document.documentElement.addEventListener("mousemove", this.doDrag, false);
                document.documentElement.addEventListener("mouseup", this.stopDrag, false);
            }.bind(this);

            for (let ind = 0; ind < elements.length; ind++) {
                let dragElmnt = elements[ind];

                let right = document.createElement("div");
                right.className = "resizer-right";
                dragElmnt.appendChild(right);
                right.addEventListener("mousedown", this.initDrag, false);
                right.parentPopup = dragElmnt;

                let bottom = document.createElement("div");
                bottom.className = "resizer-bottom";
                dragElmnt.appendChild(bottom);
                bottom.addEventListener("mousedown", this.initDrag, false);
                bottom.parentPopup = dragElmnt;

                let both = document.createElement("div");
                both.className = "resizer-both";
                dragElmnt.appendChild(both);
                both.addEventListener("mousedown", this.initDrag, false);
                both.parentPopup = dragElmnt;
            }
        };

        this.contextMenu = function () {
            function clickInsideElement(e, className) {
                let el = e.srcElement || e.target;

                if (el.classList.contains(className)) {
                    return el;
                } else {
                    while (el = el.parentNode) {
                        if (el.classList && el.classList.contains(className)) {
                            return el;
                        }
                    }
                }

                return false;
            }

            function getPosition(e) {
                if (!e) {
                    console.log('Warning! getPosition from null event!');
                    e = window.event;
                }

                if (e.pageX || e.pageY) {
                    return {
                        x: e.pageX,
                        y: e.pageY
                    }
                }
                if (e.clientX || e.clientY) {
                    return {
                        x: e.clientX + document.body.scrollLeft + document.documentElement.scrollLeft,
                        y: e.clientY + document.body.scrollTop + document.documentElement.scrollTop
                    }
                }
                console.log('getPosition warning! zeroes:', e);
                return {
                    x: 0,
                    y: 0
                }
            }


            const contextMenuLinkClassName = "context-menu__link";
            const contextMenuActive = "context-menu--active";

            const taskItemClassName = "context-target";
            let taskItemInContext;

            let clickCoords;
            let clickCoordsX;
            let clickCoordsY;

            const menu = document.querySelector("#context-menu");

            let menuState = false;
            let menuWidth;
            let menuHeight;

            let windowWidth;
            let windowHeight;

            this.init = function () {
                this.contextListener();
                this.clickListener();
                keyupListener();
                resizeListener();
            }.bind(this);

            this.contextListener = function () {
                document.addEventListener("contextmenu", function (e) {
                    let prev = taskItemInContext;
                    taskItemInContext = clickInsideElement(e, taskItemClassName);

                    if (taskItemInContext) {
                        e.preventDefault();
                        e.stopPropagation();
                        if (prev !== taskItemInContext) {
                            toggleMenuOff();
                        }
                        this.toggleMenuOn();
                        positionMenu(e);
                    } else {
                        taskItemInContext = null;
                        toggleMenuOff();
                    }
                }.bind(this));
            }.bind(this)

            this.clickListener = function () {
                document.addEventListener("click", function (e) {
                    let clickeElIsLink = clickInsideElement(e, contextMenuLinkClassName);
                    if (clickeElIsLink) {
                        e.preventDefault();
                        this.menuItemListener(clickeElIsLink);
                        e.stopPropagation();
                    } else {
                        let button = e.which || e.button;
                        if (button === 1) {
                            toggleMenuOff();
                        }
                    }
                }.bind(this));
            }.bind(this);

            function keyupListener() {
                window.onkeyup = function (e) {
                    if (e.keyCode === 27) {
                        toggleMenuOff();
                        e.stopPropagation();
                    }
                }
            }

            function resizeListener() {
                window.onresize = function (e) {
                    toggleMenuOff();
                };
            }

            this.toggleMenuOn = function () {
                if (!menuState) {
                    let html = `
<ul class="context-menu__items">
    <li class="context-menu__item">
        <a href="#" class="context-menu__link" data-action="chi">Chi-squared distribution</a>
    </li>
    <li class="context-menu__item">
        <a href="#" class="context-menu__link" data-action="dump">Dump to console</a>
    </li>
    <li class="context-menu__item">
        <a href="#" class="context-menu__link" data-action="save">Save as png</a>
    </li>
    <li class="context-menu__item">
        <a href="#" class="context-menu__link" data-action="ccm">Load CCM data</a>
    </li>
                    `;

                    if (taskItemInContext.attributes.getNamedItem('ccm') != null) {
                        html += `
    <li class="context-menu__item">
        <a href="#" class="context-menu__link" data-action="surf">Show CCM reconstruction & Surfaces</a>
    </li>
    <li class="context-menu__item">
        <a href="#" class="context-menu__link" data-action="sht">Load sht file</a>
    </li>
                        `;
                    }

                    if (taskItemInContext.attributes.getNamedItem('ne') !== null && this.m_currentShot.is_plasma) {
                        html += `
    <li class="context-menu__item">
        <a href="#" class="context-menu__link" data-action="nl42">N_e integral along R=42 chord.</a>
    </li>
                        `;
                    }
                    menu.innerHTML = html + '\n</ul>';
                    menuState = true;
                    menu.classList.add(contextMenuActive);
                }
            }.bind(this);

            function toggleMenuOff() {
                if (menuState) {
                    menu.innerHTML = 'Nothing to see here.';
                    menuState = false;
                    menu.classList.remove(contextMenuActive);
                }
            }

            function positionMenu(e) {
                clickCoords = getPosition(e);
                clickCoordsX = clickCoords.x;
                clickCoordsY = clickCoords.y;

                menuWidth = menu.offsetWidth + 4;
                menuHeight = menu.offsetHeight + 4;

                windowWidth = window.innerWidth + window.scrollX;
                windowHeight = window.innerHeight + window.scrollY;

                if ((windowWidth - clickCoordsX) < menuWidth) {
                    menu.style.left = windowWidth - menuWidth + "px";
                } else {
                    menu.style.left = clickCoordsX + "px";
                }

                if ((windowHeight - clickCoordsY) < menuHeight) {
                    menu.style.top = windowHeight - menuHeight + "px";
                } else {
                    menu.style.top = clickCoordsY + "px";
                }
            }

            this.menuItemListener = function (link) {
                toggleMenuOff();
                if (link.getAttribute("data-action") === 'chi') {
                    this.DrawChi();
                } else if (link.getAttribute("data-action") === 'dump') {
                    this.Dump(taskItemInContext.attributes);
                } else if (link.getAttribute("data-action") === 'save') {
                    this.SavePNG(taskItemInContext.id);
                } else if (link.getAttribute("data-action") === 'ccm') {
                    this.LoadCCM();
                } else if (link.getAttribute("data-action") === 'surf') {
                    this.DrawSurf();
                } else if (link.getAttribute("data-action") === 'sht') {
                    this.LoadSHT();
                } else if (link.getAttribute("data-action") === 'nl42') {
                    this.RequestChord();
                } else {
                    console.log("Target attr-s:", taskItemInContext.attributes, ", Task action - " + link.getAttribute("data-action"), link);
                }
            }.bind(this);

            this.init();

        };

        this.ConnectControls();
    }


    $(document).ready(
        function () {
            let this_html = new Main();
            this_html.DrawMain();
            console.log('loaded successfully', this_html);
        }
    );
</script>
</html>